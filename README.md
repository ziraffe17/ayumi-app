# あゆみ (AYUMI)

**福祉事業所向け通所管理システム**

AYUMI (Analytics for Your Understanding, Monitoring, and Improvement) は、福祉事業所における利用者の通所記録と生活リズムを管理するWebアプリケーションです。

---

##  目次

- [開発背景](#開発背景)
- [プロジェクト概要](#プロジェクト概要)
- [主な機能](#主な機能)
- [技術スタック](#技術スタック)
- [環境構築](#環境構築)
- [使い方](#使い方)
- [テストアカウント](#テストアカウント)
- [テスト仕様](#テスト仕様)
- [ディレクトリ構造](#ディレクトリ構造)
- [開発者向け情報](#開発者向け情報)

---

##  開発背景

### 現場の課題

福祉事業所において、利用者の「通所・退所記録」「生活リズム（日々の体調や行動記録）」を支援員が**紙やExcel、スプレッドシートで管理している**ケースが多く、以下の課題があります：

####  情報分散の問題
- 情報が分散し、面談やモニタリング時に必要なデータをすぐに取り出せない
- 過去の記録を探すのに時間がかかり、支援の質が低下

####  業務負担の問題
- 記録作業が煩雑で、支援員の負担が大きい
- 転記ミスや記入漏れが発生しやすい

####  利用者支援の問題
- 利用者自身が自分の生活リズムや出席率を振り返る機会が少ない
- 自己理解や生活改善につながりにくい

### 既存システムとの差別化

既存の福祉事業所向けシステム（例：ノウビー、かべなしクラウド等）は**「請求・加算管理」に強み**がある一方で、**利用者の生活リズムや日報を日常的に活用する仕組みは弱い**という課題があります。

一方、現場の支援員は個別支援の質向上のために「日々のちょっとした変化」を把握したいニーズが強く、利用者自身も「自分の通所状況や体調の可視化」を求める声があります。

### 本システムの目指すもの

本アプリケーションは**「請求管理ではなく、個別支援・生活改善に直結するデータ活用」**を狙いとし、以下を実現します：

**通所・退所の打刻管理**
- 利用者や支援員が簡単に出退所を記録
- 出席率を自動集計し、リアルタイムで可視化

**日報入力・セルフモニタリング**
- 利用者が体調・睡眠・食事・活動内容などを簡単入力
- 支援員も記録可能で、グラフで可視化
- 面談資料として活用可能

**支援員ビュー（面談用ダッシュボード）**
- 利用者の直近7日・30日などの出席率や生活リズムを一目で把握
- 面談や記録業務の効率化

**管理者用KPI表示**
- 事業所単位での出席率や活動状況を集計
- CSV出力可能で、会議資料・監査対応に活用

---

## プロジェクト概要

### 開発理由・目的

「通所・退所管理と日報をクラウド化し、支援員と利用者が双方で活用できるシステム」を開発し、以下を実現します：

- **支援員の業務効率化および個別支援の質向上**
- **利用者の自己理解および生活改善支援**
- **紙やExcelからの脱却によるデータ活用促進**

### 対象ユーザー
- **利用者**: 福祉事業所に通所する方々
- **職員**: 支援員（一般職員）
- **管理者**: 事業所管理者（全機能利用可能）

---

## 主な機能

### 利用者向け機能
- **ホーム画面**: 今日の予定表示、出退勤ボタン
- **個人ダッシュボード**:
  - KPI表示（出席数、出席率、日報入力率）
  - 期間フィルタ（今月/直近3ヶ月/全期間）
  - 出席率推移グラフ
  - 体調・気分トレンドグラフ
- **月次予定管理**: カレンダー形式での予定登録・編集
- **日報入力**: 朝日報（体調・睡眠）、夕日報（振り返り）

### 職員向け機能
- **職員ホーム**: 統計サマリー（登録利用者数、平均出席率等）
- **事業所ダッシュボード**:
  - 8種類のKPIカード
  - 予測稼働率計算
  - 利用者一覧・アラート表示
- **出席管理**: テーブルビューでの予定・実績管理（承認・ロック機能）
- **利用者管理**: 利用者情報のCRUD、詳細表示
- **設定画面**: 事業所情報、祝日管理、システム設定

### セキュリティ機能
- **認証**: 職員（メール + パスワード）、利用者（ログインコード）
- **2段階認証**: 職員ログイン時のメールOTP認証
- **認可制御**: ロールベースアクセス制御（RBAC）
- **監査ログ**: 操作履歴の記録（ミドルウェア実装済み）

---

## 技術スタック

| カテゴリ | 技術 |
|---------|------|
| フレームワーク | Laravel 11.x |
| 言語 | PHP 8.3 |
| データベース | MySQL 8.0 (データベース名: tsusho) |
| キャッシュ/セッション | Redis 7 |
| メール（開発環境） | Mailhog |
| コンテナ | Docker & Docker Compose |
| フロントエンド | Blade Template + Vanilla JavaScript + Chart.js |
| 開発環境 | Windows (PowerShell) |

---

## 環境構築

### 前提条件
- Docker Desktop インストール済み
- Git インストール済み
- ポート 8080, 3306, 6379, 8025 が空いていること

### セットアップ手順

#### 1. リポジトリのクローン
```bash
git clone <repository-url>
cd php-selfmade
```

#### 2. Dockerコンテナの起動
```powershell
docker compose up -d
```

起動確認:
```powershell
docker compose ps
```

#### 3. 依存関係のインストール
```powershell
docker compose exec app composer install
```

#### 4. 環境変数の設定
```powershell
# .envファイルは既に設定済み（開発環境用）
# 本番環境では .env.example を参照して設定してください
```

#### 5. アプリケーションキーの生成
```powershell
docker compose exec app php artisan key:generate
```

#### 6. データベースのマイグレーション
```powershell
docker compose exec app php artisan migrate
```

#### 7. テストデータの投入
```powershell
# 利用者データ
docker compose exec app php artisan db:seed --class=AdditionalUsersSeeder

# 出席予定・実績データ
docker compose exec app php artisan db:seed --class=AdditionalAttendanceSeeder

# 日報データ
docker compose exec app php artisan db:seed --class=AdditionalDailyReportsSeeder
```

#### 8. アクセス確認
- **アプリケーション**: http://localhost:8080
- **Mailhog (メール確認)**: http://localhost:8025

---

## テストアカウント

### 利用者アカウント

| ユーザー名 | ログインコード | パスワード | 利用開始月 | 備考 |
|-----------|--------------|----------|----------|------|
| テスト太郎 | u0001 | password | 2025-07-01 | 7月〜10月データあり |
| 佐藤花子 | u0002 | password | 2025-08-01 | 8月〜10月データあり |
| 鈴木太郎 | u0003 | password | 2025-09-01 | 9月〜10月データあり |

### 職員アカウント

| メールアドレス | パスワード | 権限 | 備考 |
|--------------|----------|------|------|
| admin@example.com | password | 管理者 | 全機能利用可能（設定画面含む） |
| staff@example.com | password | 一般職員 | 設定画面以外の機能利用可能 |

**2段階認証**: 職員ログイン時に http://localhost:8025 でOTPコードを確認してください。

**権限テスト**:
-  一般職員（staff@example.com）で設定画面にアクセス → 403エラー
-  利用者アカウントで職員画面にアクセス → ログイン画面にリダイレクト

---

## テスト実施結果

### 総合評価（2025年10月6日実施）

- **実施ケース数**: 76件
- **成功**: 74件（**97.4%**）
- **未実装/保留**: 2件（承認・ロック機能）

### パフォーマンステスト結果

| 項目 | 目標 | 実測 | 判定 |
|------|------|------|------|
| 個人ダッシュボード | 2秒以内 | 2.55秒（API） | ⚠️ 目標未達（35%改善） |
| 出席管理（25名） | 3秒以内 | 4.47秒 | ⚠️ 目標未達（40%改善） |
| 祝日API | - | 1.36秒 | ✅ 良好（49%改善） |

**パフォーマンス最適化内容**:
- N+1クエリ問題を解消（バッチローディング実装）
- データベースクエリ数を62%削減（16→6クエリ）
- キャッシュ戦略の実装（祝日API等）

### 実装済み機能確認

#### 認証・認可
- 職員ログイン（2段階認証含む）
- 利用者ログイン
- マルチガード認証（web/staff）
- 権限制御（管理者/一般職員）
- 未認証アクセス防止

#### CRUD機能
- 出席予定の登録・編集・削除
- 出席実績の登録・編集・削除
- 日報（朝・夕）の登録・編集
- 利用者管理（登録・編集・無効化）
- 祝日管理（CSV/API取り込み、手動登録）

#### ダッシュボード機能
- 個人ダッシュボード（KPI表示、グラフ表示）
- 事業所ダッシュボード（8種類のKPIカード）
- 期間フィルタ（今月/直近3ヶ月/全期間）
- 出席率推移グラフ（全期間表示）
- 体調・気分トレンドグラフ（直近7日）

#### セキュリティ
- XSS対策（Bladeの自動エスケープ）
- SQLインジェクション対策（Eloquent ORM）
- CSRF対策（Laravel標準機能）
- セッション管理（暗号化、HTTPOnly、Secure Cookie）
- パスワード暗号化（bcrypt）

#### インフラ
- データベース接続（MySQL 8.0.42）
- Redis接続（キャッシュ/セッション）
- メール送信（Mailhog）
- ログ出力（laravel.log）
- エラーページ（404/500/403）

### 未実装機能
1. 出席実績の承認機能（`api/attendance/records/{id}/approve`）
2. 出席実績のロック機能（`api/attendance/records/{id}/lock`）
3. 監査ログミドルウェアの全画面適用


---

## ディレクトリ構造

```
php-selfmade/
├── docker/                 # Docker設定
│   ├── app/               # PHP-FPM設定
│   ├── web/               # Nginx設定
│   └── db/                # MySQL初期化
├── src/                   # Laravelアプリケーション
│   ├── app/
│   │   ├── Http/Controllers/
│   │   │   ├── Api/      # API用コントローラー
│   │   │   ├── Staff/    # 職員用コントローラー
│   │   │   └── User/     # 利用者用コントローラー
│   │   ├── Models/       # Eloquentモデル
│   │   └── Services/     # ビジネスロジック
│   ├── database/
│   │   ├── migrations/   # マイグレーション
│   │   └── seeders/      # シーダー
│   ├── resources/views/
│   │   ├── layouts/      # レイアウト
│   │   ├── staff/        # 職員用ビュー
│   │   └── user/         # 利用者用ビュー
│   └── routes/
│       ├── web.php       # Webルーティング
│       └── api.php       # APIルーティング
├── docs/
│   └── test/             # テスト仕様書
├── docker-compose.yml
└── README.md             # このファイル
```

---

## 開発者向け情報

### よく使うコマンド

#### Dockerコンテナ操作
```powershell
# 起動
docker compose up -d

# 停止
docker compose down

# ログ確認
docker compose logs -f app

# コンテナ内作業
docker compose exec app bash
```

#### Laravel操作
```powershell
# マイグレーション
docker compose exec app php artisan migrate

# キャッシュクリア
docker compose exec app php artisan cache:clear
docker compose exec app php artisan config:clear

# ルート確認
docker compose exec app php artisan route:list
```

#### MySQL操作（Windows）
```powershell
# テーブル一覧確認
winpty docker exec -it php-selfmade-db-1 mysql -u root -ppassword tsusho -e "SHOW TABLES;"

# 出席予定確認
winpty docker exec -it php-selfmade-db-1 mysql -u root -ppassword tsusho -e "SELECT * FROM attendance_plans WHERE user_id=1 LIMIT 10;"
```

### 主要な実装機能

#### KPI計算ロジック
- **出席率**: `予定日数 ÷ 実績日数 × 100`（当月は前日まで）
- **欠席数**: `attendance_type = 'absent'` の件数
- **日報入力率**: `出席日数 ÷ 日報入力日数 × 100`

#### セキュリティ対策

本システムでは以下のセキュリティ対策を実装済みです：

##### XSS（クロスサイトスクリプティング）対策
- **Bladeテンプレートの自動エスケープ**: `{{ $variable }}` 構文で自動的にHTMLエスケープ
- **エスケープなし出力の禁止**: `{!! !!}` 構文は使用していません（全ビュー確認済み）
- **検証結果**: 27箇所で`@csrf`トークンを使用、エスケープなし出力は0件

##### SQLインジェクション対策
- **Eloquent ORM使用**: 全データベースクエリでEloquent ORMを使用
- **プリペアドステートメント**: Eloquentが自動的にパラメータをバインド
- **DB::raw()の最小化**: 固定値の文字セット設定のみで使用（AppServiceProvider:20）
- **LIKE句の安全な使用**: 検索フィルタでもEloquentのバインディング機能を使用

##### CSRF（クロスサイトリクエストフォージェリ）対策
- **Laravel標準のCSRF保護**: 全POST/PUT/DELETEリクエストで自動検証
- **トークン実装**: 15ファイルで`@csrf`ディレクティブを使用
- **APIルート**: API経由のリクエストもCSRFトークンを検証

##### 認証・認可
- **マルチガード認証**: 利用者（`auth:web`）と職員（`auth:staff`）を完全分離
- **未認証アクセス防止**: 全保護ルートでミドルウェアによるリダイレクト（302）
- **権限制御**: 管理者のみが設定画面にアクセス可能（`admin`ミドルウェア）
- **2段階認証**: 職員ログイン時のメールOTP認証

##### セッション管理
- **セッション暗号化**: `SESSION_ENCRYPT=true`（本番環境）
- **HTTPOnly Cookie**: JavaScriptからのアクセス防止（デフォルト有効）
- **Secure Cookie**: HTTPS通信のみでCookie送信（本番環境で必須）
- **SameSite属性**: `lax`設定でCSRF攻撃を軽減
- **セッション有効期限**: 120分（設定変更可能）

##### パスワードセキュリティ
- **bcrypt暗号化**: `BCRYPT_ROUNDS=12`でハッシュ化
- **パスワードリセット**: トークンベースの安全なリセット機能
- **2FA対応**: 職員ログイン時の追加認証層

##### 本番環境で必須の追加対策
- **HTTPS必須化**: Webサーバー（Nginx）でHTTPSリダイレクト設定
- **環境変数の適切な管理**: `.env`ファイルの権限設定（600）
- **レート制限**: ログイン試行回数の制限（設定済み）
- **監査ログの有効化**: 必要に応じて`audit`ミドルウェアを適用

### パフォーマンス最適化

本システムでは以下のパフォーマンス最適化を実施しています：

#### N+1クエリ問題の解消
- **問題**: ループ内での個別クエリ実行により、大量のSQLが発生
- **解決**: `whereIn()` + `groupBy()` によるバッチローディング
- **効果**: クエリ数を62-75%削減

#### キャッシュ戦略
- **祝日データ**: 24時間キャッシュ（変更頻度が低い）
- **ダッシュボードAPI**: 条件付きキャッシュ
- **キャッシュドライバ**: Redis使用

#### クエリ最適化
- **必要なカラムのみ取得**: `select()` で必要なカラムを明示
- **インデックス活用**: 日付・外部キーにインデックス設定
- **Collectionフィルタリング**: メモリ上でのデータ絞り込み

#### 測定結果（2025年10月6日）
| 対象 | 改善前 | 改善後 | 改善率 |
|------|--------|--------|--------|
| 個人ダッシュボードAPI | 3.91秒 | 2.55秒 | 35% |
| 出席管理API | 3.14秒 | 1.06秒 | 66% |
| 祝日API | 2.67秒 | 1.36秒 | 49% |

### トラブルシューティング

#### コンテナが起動しない
```powershell
docker compose down
docker compose up -d
```

#### 画面が表示されない
```powershell
docker compose exec app php artisan config:clear
docker compose exec app php artisan cache:clear
docker compose exec app php artisan view:clear
```

#### データベース接続エラー
```powershell
# データベース接続確認
docker compose exec app php artisan db:show
```

---

---

## 本番環境への展開

本番環境への展開前に以下を実施してください：

### 必須対応
1. `.env.example` をコピーして `.env` を作成
2. `APP_KEY` を生成（`php artisan key:generate`）
3. `APP_ENV=production`、`APP_DEBUG=false` に設定
4. データベース接続情報の設定
5. メール設定（SMTP）の設定
6. HTTPS設定（Webサーバー）
7. セッションドライバーをRedisに変更
8. 管理者アカウントの作成
9. 祝日データの取り込み
10. **テストデータの削除**（user_id=1,2,3）

---

## ライセンス

このプロジェクトは教育目的で作成されています。

---

## 作成者

作成日: 2025年10月5日


